(function(){ 'use strict'; var TWA=(typeof window!=='undefined'&&window.Telegram&&window.Telegram.WebApp)?window.Telegram.WebApp:null; var state={theme:'light',history:[],screens:{}}; function qs(s,c){return (c||document).querySelector(s)} function qsa(s,c){return Array.from((c||document).querySelectorAll(s))} function setThemeFromTelegram(){ if(!TWA){document.documentElement.setAttribute('data-theme',window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');return;} var tp=TWA.themeParams||{}; var isDark=(TWA.colorScheme==='dark'); document.documentElement.setAttribute('data-theme',isDark?'dark':'light'); } function showToast(msg){var t=qs('#toast');t.textContent=msg;t.style.display='block';setTimeout(function(){t.style.display='none'},1600);} function activateScreen(id, options){ var all=qsa('.screen'); all.forEach(function(s){s.classList.remove('active')}); var el=qs('#'+id); if(!el){showToast('Экран не найден: '+id);return;} el.classList.add('active'); if(options&&options.pushHistory){state.history.push(id);} qs('#backBtn').disabled=(state.history.length<=1); } function goBack(){ if(state.history.length<=1){return;} state.history.pop(); var prev=state.history[state.history.length-1]; activateScreen(prev,{pushHistory:false}); } function ensureButtons(){ qsa('[data-target]').forEach(function(btn){ var target=btn.getAttribute('data-target'); if(!qs('#'+target)){btn.disabled=true; btn.title='Экран в разработке'; btn.style.cursor='not-allowed';} btn.addEventListener('click', function(){ if(btn.disabled){showToast('Ещё не готово'); return;} activateScreen(target,{pushHistory:true}); }); }); // close/exit button var closeBtn=qs('#closeBtn'); if(closeBtn){ closeBtn.addEventListener('click', function(){ // Rebuild modals on close: remove any .modal-backdrop instances qsa('.modal-backdrop').forEach(function(m){m.remove();}); if(TWA && TWA.close) { try{ TWA.close(); }catch(e){ activateScreen('main-screen',{pushHistory:true}); } } else { activateScreen('main-screen',{pushHistory:true}); } }); } var openModalBtn=qsa('[data-modal]'); openModalBtn.forEach(function(btn){ btn.addEventListener('click', function(){ openModal(btn.getAttribute('data-modal')); }); }); } function openModal(id){ // modal content by id or generic var content=qs('#'+id) ? qs('#'+id).innerHTML : '<h3>Модалка</h3><p>Повторное использование после закрытия.</p>'; var backdrop=document.createElement('div'); backdrop.className='modal-backdrop'; backdrop.innerHTML='<div class="modal" role="dialog" aria-modal="true"><button class="sr-only" aria-label="close"></button>'+content+'</div>'; document.body.appendChild(backdrop); backdrop.style.display='flex'; function close(){backdrop.remove();} backdrop.addEventListener('click',function(e){ if(e.target===backdrop) close(); }); var x = backdrop.querySelector('[data-modal-close]'); if(x){ x.addEventListener('click', close); } } function init(){ document.body.style.overflow='hidden'; // disable scroll setThemeFromTelegram(); if(TWA){ try{ TWA.ready(); TWA.expand(); }catch(e){} } // History init state.history=['main-screen']; activateScreen('main-screen',{pushHistory:false}); ensureButtons(); // Accessibility qsa('button').forEach(function(b){b.setAttribute('aria-pressed','false'); b.addEventListener('mousedown',function(){b.setAttribute('aria-pressed','true')}); b.addEventListener('mouseup',function(){b.setAttribute('aria-pressed','false')}); }); // Error handling fallback example window.addEventListener('error',function(e){ console.error(e); showToast('Ошибка: '+(e.message||'неизвестно')); }); window.addEventListener('unhandledrejection',function(e){ console.error(e); showToast('Сбой запроса'); }); } document.addEventListener('DOMContentLoaded', init); window.__MiniApp={activateScreen,goBack,openModal}; })();